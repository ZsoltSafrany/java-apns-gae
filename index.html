<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>java-apns-gae by ZsoltSafrany</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>java-apns-gae</h1>
        <p>Java APNS library that works on Google App Engine</p>

        <p class="view"><a href="https://github.com/ZsoltSafrany/java-apns-gae">View the Project on GitHub <small>ZsoltSafrany/java-apns-gae</small></a></p>


        <ul>
          <li><a href="https://github.com/ZsoltSafrany/java-apns-gae/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/ZsoltSafrany/java-apns-gae/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/ZsoltSafrany/java-apns-gae">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="introduction" class="anchor" href="#introduction"><span class="octicon octicon-link"></span></a>Introduction</h1>

<p>This is a Java Apple Push Notification Service library that works on Google App Engine. It was designed to work (and be used) on Google App Engine but it doesn't have any GAE specific dependencies; you may use it anywhere where Java runs. </p>

<div class="highlight highlight-java"><pre><span class="k">new</span> <span class="nf">PushNotification</span><span class="o">()</span>
  <span class="o">.</span><span class="na">setAlert</span><span class="o">(</span><span class="s">"You got your emails."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setBadge</span><span class="o">(</span><span class="mi">9</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setSound</span><span class="o">(</span><span class="s">"bingbong.aiff"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setDeviceTokens</span><span class="o">(</span><span class="s">"777d2ac490a17bb1d4c8a6ec7c50d4b1b9a36499acd45bf5fcac103cde038eff"</span><span class="o">);</span>
</pre></div>

<p>The library works on Java 7 and above. </p>

<h1>
<a name="features" class="anchor" href="#features"><span class="octicon octicon-link"></span></a>Features</h1>

<h2>
<a name="create-a-push-notification" class="anchor" href="#create-a-push-notification"><span class="octicon octicon-link"></span></a>Create a push notification</h2>

<h3>
<a name="create-a-simple-push-notification" class="anchor" href="#create-a-simple-push-notification"><span class="octicon octicon-link"></span></a>Create a simple push notification</h3>

<div class="highlight highlight-java"><pre><span class="k">new</span> <span class="nf">PushNotification</span><span class="o">()</span>
  <span class="o">.</span><span class="na">setAlert</span><span class="o">(</span><span class="s">"You got your emails."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setBadge</span><span class="o">(</span><span class="mi">9</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setSound</span><span class="o">(</span><span class="s">"bingbong.aiff"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setDeviceTokens</span><span class="o">(</span><span class="s">"777d2ac490a17bb1d4c8a6ec7c50d4b1b9a36499acd45bf5fcac103cde038eff"</span><span class="o">);</span>
</pre></div>

<p>Note, that if you don't set a <code>Badge</code> value then the badge won't change. To remove the badge, set the value to 0.</p>

<p>You can send the same push notification to more than one device. The overloaded methods you can use are:</p>

<div class="highlight highlight-java"><pre><span class="o">.</span><span class="na">setDeviceTokens</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">deviceTokens</span><span class="o">)</span>
<span class="o">.</span><span class="na">setDeviceTokens</span><span class="o">(</span><span class="n">Collection</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">deviceTokens</span><span class="o">)</span>
</pre></div>

<h3>
<a name="create-with-complex-alert" class="anchor" href="#create-with-complex-alert"><span class="octicon octicon-link"></span></a>Create with complex alert</h3>

<div class="highlight highlight-java"><pre><span class="n">ComplexAlert</span> <span class="n">complexAlert</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ComplexAlert</span><span class="o">()</span>
  <span class="o">.</span><span class="na">setBody</span><span class="o">(</span><span class="s">"Bob wants to play poker"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setActionLocKey</span><span class="o">(</span><span class="s">"PLAY"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setLocKey</span><span class="o">(</span><span class="s">"GAME_PLAY_REQUEST_FORMAT"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setLocArgs</span><span class="o">(</span><span class="s">"Jenna"</span><span class="o">,</span> <span class="s">"Frank"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setLaunchImage</span><span class="o">(</span><span class="s">"AllIn.png"</span><span class="o">);</span>
<span class="k">new</span> <span class="nf">PushNotification</span><span class="o">().</span><span class="na">setComplexAlert</span><span class="o">(</span><span class="n">complexAlert</span><span class="o">);</span>
</pre></div>

<p>For a description of these properties check out the <a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html">Local and Push Notification Programming Guide</a>. </p>

<h3>
<a name="create-with-custom-payload" class="anchor" href="#create-with-custom-payload"><span class="octicon octicon-link"></span></a>Create with custom payload</h3>

<div class="highlight highlight-java"><pre><span class="k">new</span> <span class="nf">PushNotification</span><span class="o">()</span>
  <span class="o">.</span><span class="na">setAlert</span><span class="o">(</span><span class="s">"This is a notification with custom payload."</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setDeviceTokens</span><span class="o">(</span><span class="s">"777d2ac490a17bb1d4c8a6ec7c50d4b1b9a36499acd45bf5fcac103cde038eff"</span><span class="o">)</span>
  <span class="o">.</span><span class="na">setCustomPayload</span><span class="o">(</span><span class="s">"acme1"</span><span class="o">,</span> <span class="s">"bar"</span><span class="o">);</span>
  <span class="o">.</span><span class="na">setCustomPayload</span><span class="o">(</span><span class="s">"acme2"</span><span class="o">,</span> <span class="mi">42</span><span class="o">);</span>
</pre></div>

<p>You should not include customer information (or any sensitive data) as custom payload data. </p>

<p>Remember, that the maximum size allowed for a notification payload is 2048 bytes. <code>PushNotificationService.send()</code> will throw a <code>PayloadException</code> when you try to pass a <code>PushNotification</code> that results in a payload that exceeds this limit.</p>

<h2>
<a name="send-a-push-notification" class="anchor" href="#send-a-push-notification"><span class="octicon octicon-link"></span></a>Send a push notification</h2>

<p>To send a push notification you will need two more things: a <code>PushNotificationService</code> and an <code>ApnsConnection</code>. If you have both you just say:</p>

<div class="highlight highlight-java"><pre><span class="n">PushNotification</span> <span class="n">pn</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// push notification you created</span>
<span class="n">PushNotificationService</span> <span class="n">pns</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// obtain one</span>
<span class="n">ApnsConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// obtain one</span>
<span class="n">pns</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">pn</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
</pre></div>

<h3>
<a name="obtain-a-pushnotificationservice" class="anchor" href="#obtain-a-pushnotificationservice"><span class="octicon octicon-link"></span></a>Obtain a PushNotificationService</h3>

<p>This is quite simple; use the provided default implementation:</p>

<div class="highlight highlight-java"><pre><span class="n">PushNotificationService</span> <span class="n">pns</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DefaultPushNotificationService</span><span class="o">();</span>
</pre></div>

<h3>
<a name="obtain-an-apnsconnection" class="anchor" href="#obtain-an-apnsconnection"><span class="octicon octicon-link"></span></a>Obtain an ApnsConnection</h3>

<p>You can create <code>ApnsConnection</code> instances with an <code>ApnsConnectionFactory</code>. Use the provided default factory implementation <code>DefaultApnsConnectionFactory</code>: </p>

<div class="highlight highlight-java"><pre><span class="n">DefaultApnsConnectionFactory</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DefaultApnsConnectionFactory</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
<span class="k">if</span> <span class="o">(</span><span class="n">usingProductionApns</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">KeyStoreProvider</span> <span class="n">ksp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ClassPathResourceKeyStoreProvider</span><span class="o">(</span><span class="s">"apns/apns_certificates_production.p12"</span><span class="o">,</span> <span class="n">KeyStoreType</span><span class="o">.</span><span class="na">PKCS12</span><span class="o">,</span> <span class="n">KEYSTORE_PASSWORD</span><span class="o">);</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">setProductionKeyStoreProvider</span><span class="o">(</span><span class="n">ksp</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
  <span class="n">KeyStoreProvider</span> <span class="n">ksp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ClassPathResourceKeyStoreProvider</span><span class="o">(</span><span class="s">"apns/apns_certificates_sandbox.p12"</span><span class="o">,</span> <span class="n">KeyStoreType</span><span class="o">.</span><span class="na">PKCS12</span><span class="o">,</span> <span class="n">KEYSTORE_PASSWORD</span><span class="o">);</span>
  <span class="n">builder</span><span class="o">.</span><span class="na">setSandboxKeyStoreProvider</span><span class="o">(</span><span class="n">ksp</span><span class="o">);</span>
<span class="o">}</span>
<span class="n">ApnsConnectionFactory</span> <span class="n">acf</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>

<span class="n">ApnsConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">acf</span><span class="o">.</span><span class="na">openPushConnection</span><span class="o">();</span>
</pre></div>

<p>Each call to <code>openPushConnection()</code> will open and create a new connection to APNS.</p>

<p>The example uses keystores that are located on the classpath. In a usual Maven project, these two example keystores are located at <code>src/main/resources/apns/apns_certificates_{production|sandbox}.p12</code>. If you want to load the keystores yourself then use class <code>WrapperKeyStoreProvider</code> instead:</p>

<div class="highlight highlight-java"><pre><span class="n">KeyStore</span> <span class="n">ks</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// keystore you loaded manually</span>
<span class="n">KeyStoreProvider</span> <span class="n">ksp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">WrapperKeyStoreProvider</span><span class="o">(</span><span class="n">ks</span><span class="o">,</span> <span class="n">KEYSTORE_PASSWORD</span><span class="o">);</span>
<span class="n">builder</span><span class="o">.</span><span class="na">setProductionKeyStoreProvider</span><span class="o">(</span><span class="n">ksp</span><span class="o">);</span>
</pre></div>

<h2>
<a name="read-the-feedback-service" class="anchor" href="#read-the-feedback-service"><span class="octicon octicon-link"></span></a>Read the Feedback Service</h2>

<p>The Apple Push Notification Service includes a feedback service to give you information about failed push notifications.</p>

<p>To read the feedback service you will need two things: a <code>FeedbackService</code> and an <code>ApnsConnection</code>. If you have both you just say:</p>

<div class="highlight highlight-java"><pre><span class="n">ApnsConnectionFactory</span> <span class="n">acf</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// obtain one</span>
<span class="n">ApnsConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">acf</span><span class="o">.</span><span class="na">openFeedbackConnection</span><span class="o">();</span>
<span class="n">FeedbackService</span> <span class="n">fs</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DefaultFeedbackService</span><span class="o">();</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">FailedDeviceToken</span><span class="o">&gt;</span> <span class="n">failedTokens</span> <span class="o">=</span> <span class="n">fs</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>

<span class="k">for</span> <span class="o">(</span><span class="n">FailedDeviceToken</span> <span class="n">failedToken</span> <span class="o">:</span> <span class="n">failedTokens</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">failedToken</span><span class="o">.</span><span class="na">getFailTimestamp</span><span class="o">();</span>
  <span class="n">failedToken</span><span class="o">.</span><span class="na">getDeviceToken</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>

<p>Note that this time the <code>ApnsConnection</code> is obtained with <code>openFeedbackConnection()</code> instead of <code>openPushConnection()</code> (as the feedback service listens on a different address than the push service).</p>

<p>Use <code>getFailTimestamp()</code> to verify that the device token hasn’t been reregistered since the feedback entry was generated. For each device that has not been reregistered, stop sending notifications. </p>

<p>The feedback service’s list is cleared after you read it. Each time you call <code>FeedbackService.read()</code>, the information it returns lists only the failures that have happened since the last <code>read()</code>.</p>

<h2>
<a name="test-your-code" class="anchor" href="#test-your-code"><span class="octicon octicon-link"></span></a>Test your code</h2>

<p>You can test your code that uses this library quite easily as <code>ApnsConnection</code>, <code>ApnsConnectionFactory</code>, <code>PushNotificationService</code> and <code>FeedbackService</code> are all interfaces. You may create whatever mock objects you need for testing. However, the library includes some convenient mock implementations:</p>

<h3>
<a name="mockapnsconnectionfactory" class="anchor" href="#mockapnsconnectionfactory"><span class="octicon octicon-link"></span></a>MockApnsConnectionFactory</h3>

<p>It returns mock connections. Use this to create <code>ApnsConnection</code> instances for the following two classes.</p>

<h3>
<a name="mockpushnotificationservice" class="anchor" href="#mockpushnotificationservice"><span class="octicon octicon-link"></span></a>MockPushNotificationService</h3>

<div class="highlight highlight-java"><pre><span class="n">MockPushNotificationService</span> <span class="n">mpns</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MockPushNotificationService</span><span class="o">();</span>

<span class="c1">// code under test</span>
<span class="n">PushNotificationService</span> <span class="n">pns</span> <span class="o">=</span> <span class="n">mpns</span><span class="o">;</span>
<span class="n">pns</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">pushNotification</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>

<span class="c1">// assertions</span>
<span class="n">String</span> <span class="n">deviceToken</span> <span class="o">=</span> <span class="s">"777d2ac490a17bb1d4c8a6ec7c50d4b1b9a36499acd45bf5fcac103cde038eff"</span><span class="o">;</span>
<span class="n">assertTrue</span><span class="o">(</span><span class="n">mpns</span><span class="o">.</span><span class="na">pushWasSentTo</span><span class="o">(</span><span class="n">deviceToken</span><span class="o">));</span>
<span class="n">PushNotification</span> <span class="n">pn</span> <span class="o">=</span> <span class="n">mpns</span><span class="o">.</span><span class="na">getLastPushSentToDevice</span><span class="o">(</span><span class="n">deviceToken</span><span class="o">);</span> 
</pre></div>

<p>This way you can assert that a push notification was sent; you can make sure that your code under test did send a push notification to a specific device token.</p>

<p>With <code>getLastPushSentToDevice()</code> you can also obtain the push notification itself that was "sent" (passed to the mock implementation).</p>

<h3>
<a name="mockfeedbackservice" class="anchor" href="#mockfeedbackservice"><span class="octicon octicon-link"></span></a>MockFeedbackService</h3>

<div class="highlight highlight-java"><pre><span class="n">MockFeedbackService</span> <span class="n">mfs</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MockFeedbackService</span><span class="o">();</span>
<span class="n">mfs</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">"777d2ac490a17bb1d4c8a6ec7c50d4b1b9a36499acd45bf5fcac103cde038eff"</span><span class="o">);</span>

<span class="n">FeedbackService</span> <span class="n">fs</span> <span class="o">=</span> <span class="n">mfs</span><span class="o">;</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">FailedDeviceToken</span><span class="o">&gt;</span> <span class="n">failedTokens</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span>
</pre></div>

<p>This way you can simulate the feedback service giving back a list of failed tokens; you can make sure, for instance, that your code under test does delete device tokens (returned by the feedback service) from your database.</p>

<p>Like in case of the real feedback service, the list of failed tokens are cleared after you call <code>read()</code>.</p>

<h2>
<a name="make-it-work-on-app-engine" class="anchor" href="#make-it-work-on-app-engine"><span class="octicon octicon-link"></span></a>Make it work on App Engine</h2>

<p>So far everything was independent from App Engine. In this section you'll see how to use the library efficiently on GAE.</p>

<h3>
<a name="sockets-the-2-minutes-problem" class="anchor" href="#sockets-the-2-minutes-problem"><span class="octicon octicon-link"></span></a>Sockets; the 2 minutes problem</h3>

<p>Sockets may be reclaimed after 2 minutes of inactivity on App Engine. See <a href="https://developers.google.com/appengine/docs/java/sockets/">Limitations and restrictions</a>.</p>

<p>And the problem is you can't keep a socket connected to APNS artifically open; without sending actual push notifications. The only way to keep it open is to send some arbitrary data/bytes but that would result in an immediate closure of the socket; APNS closes the connection as soon as it detects something that does not conform to the protocol, i.e. something that is not an actual push notification.</p>

<h4>
<a name="so_keepalive" class="anchor" href="#so_keepalive"><span class="octicon octicon-link"></span></a><code>SO_KEEPALIVE</code>
</h4>

<p>What about <code>SO_KEEPALIVE</code>? App Engine explicitly says it is supported. I think it just means it won't throw an exception when you call <code>Socket.setKeepAlive(true)</code>; calls wanted to set socket options raised Not Implemented exceptions before. Even if you enable keep-alive your socket will be reclaimed (closed) if you don't send something for more than 2 minutes; at least on App Engine as of 08.22.2014. </p>

<p>Actually, it's not a big surprise. <a href="http://tools.ietf.org/html/rfc1122#page-101">RFC1122</a> that specifies TCP Keep Alive explicitly states that TCP Keep Alives are not to be sent more than once every two hours, and then, it is only necessary if there was no other traffic. Although, it also says that this interval must be also configurable, there is no API on <code>java.net.Socket</code> you could use to configure that (most probably because it's highly OS dependent) and I doubt it would be set to 2 minutes on App Engine. </p>

<h3>
<a name="so_timeout" class="anchor" href="#so_timeout"><span class="octicon octicon-link"></span></a><code>SO_TIMEOUT</code>
</h3>

<p>What about <code>SO_TIMEOUT</code>? It is for something completely else. The javadoc of <code>Socket.setSoTimeout()</code> states:</p>

<pre><code>Enable/disable SO_TIMEOUT with the specified timeout, in milliseconds. With this 
option set to a non-zero timeout, a read() call on the InputStream associated 
with this Socket will block for only this amount of time. If the timeout expires, 
a java.net.SocketTimeoutException is raised, though the Socket is still valid. 
The option must be enabled prior to entering the blocking operation to have effect. 
The timeout must be &gt; 0. A timeout of zero is interpreted as an infinite timeout.
</code></pre>

<p>That is, when <code>read()</code> is blocking for too long because there's nothing to read you can say "ok, I don't want to wait (block) anymore; let's do something else instead". It's not going to help with our "2 minutes" problem.</p>

<h3>
<a name="what-then" class="anchor" href="#what-then"><span class="octicon octicon-link"></span></a>What then?</h3>

<p>The only way you can work around this problem is this: detect when a connection is reclaimed/closed then throw it away and open a new connection. And this library supports exactly that.</p>

<div class="highlight highlight-java"><pre><span class="c1">// do this only once</span>
<span class="n">ApnsConnectionFactory</span> <span class="n">acf</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// obtain one</span>
<span class="n">PushNotificationService</span> <span class="n">pns</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// obtain one</span>

<span class="c1">// do this every time you want to send a push notification</span>
<span class="n">PushNotification</span> <span class="n">pn</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// create push notification</span>
<span class="n">ApnsConnection</span> <span class="n">connection</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// already opened and cached connection</span>
<span class="k">try</span> <span class="o">{</span>
  <span class="n">pns</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">pn</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CannotUseConnectionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// throw away connection (i.e. just simply lose all your references to the object) </span>
  <span class="c1">// and open new connection</span>
  <span class="n">connection</span> <span class="o">=</span> <span class="n">acf</span><span class="o">.</span><span class="na">openPushConnection</span><span class="o">();</span>
  <span class="n">pns</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="n">pn</span><span class="o">,</span> <span class="n">connection</span><span class="o">);</span> <span class="c1">// it should work now; we are using a just-opened connection</span>
  <span class="n">cacheConnection</span><span class="o">(</span><span class="n">connection</span><span class="o">);</span> <span class="c1">// hoping you can successfuly reuse it the next time</span>
<span class="o">}</span>

</pre></div>

<p>It is possible that the socket is not reclaimed but you still receive a <code>CannotUseConnectionException</code>. This can happen because of any transient issue (e.g. networking, App Engine, APNS) and you should throw away the connection just the very same way; should happen very rarely, though.</p>

<h3>
<a name="more-detailed-app-engine-example" class="anchor" href="#more-detailed-app-engine-example"><span class="octicon octicon-link"></span></a>More detailed App Engine example</h3>

<p>Now it's clear that reusing, throwing away and opening new connections is the way to go. Let me show you a more detailed example of how the library could be used on App Engine. I will assume that you are familiar with App Engine itself.</p>

<p>Let's give an overview of the example: we'll a have separate (basic-scaling) App Engine module (let's call it <code>apns</code>) that will be doing only one thing, sending push notifications to APNS. We will never send push notficiations in the current, user-initiated request; we will have a push queue for enqueuing tasks responsible for sending push notifications. Tasks will be executed in the <code>apns</code> module; tasks can be enqueued from anywhere. Our <code>apns</code> module will have some (let's say <code>5</code>) concurrent socket connections (well, <code>ApnsConnection</code> instances) that the module will keep in a pool for reuse. </p>

<p>So, let's see how to do that.</p>

<h4>
<a name="separate-apns-module" class="anchor" href="#separate-apns-module"><span class="octicon octicon-link"></span></a>Separate <code>apns</code> module</h4>

<p>Let's create a separate module. Its <code>appengine-web.xml</code> file looks like this:</p>

<div class="highlight highlight-xml"><pre><span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;appengine-web-app</span> <span class="na">xmlns=</span><span class="s">"http://appengine.google.com/ns/1.0"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;application&gt;</span>your-app-name<span class="nt">&lt;/application&gt;</span>
    <span class="nt">&lt;module&gt;</span>apns<span class="nt">&lt;/module&gt;</span>
    <span class="nt">&lt;version&gt;</span>your-version<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;threadsafe&gt;</span>true<span class="nt">&lt;/threadsafe&gt;</span>
    <span class="nt">&lt;instance-class&gt;</span>B1<span class="nt">&lt;/instance-class&gt;</span>
    <span class="nt">&lt;basic-scaling&gt;</span>
        <span class="nt">&lt;max-instances&gt;</span>1<span class="nt">&lt;/max-instances&gt;</span>
        <span class="nt">&lt;idle-timeout&gt;</span>10m<span class="nt">&lt;/idle-timeout&gt;</span>
    <span class="nt">&lt;/basic-scaling&gt;</span>

    <span class="nt">&lt;system-properties&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"java.util.logging.config.file"</span> <span class="na">value=</span><span class="s">"WEB-INF/logging.properties"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;/system-properties&gt;</span>
<span class="nt">&lt;/appengine-web-app&gt;</span>
</pre></div>

<p>It says it's a <code>basic-scaling</code> module with the cheapest instance. We use <code>basic-scaling</code> because this way (unlike <code>automatic-scaling</code>) we can limit the number of instances and thus the number of concurrent APNS connections, plus (unlike <code>manual-scaling</code>) we don't need to bother about instance startup/shutdown as idle instances will be shut down (saving us money).</p>

<p>In our example, we set the limit of maximum instances to <code>1</code> and that one instance will be shut down if it's idle for more than <code>10</code> minutes.</p>

<h4>
<a name="push-queue" class="anchor" href="#push-queue"><span class="octicon octicon-link"></span></a>Push queue</h4>

<p>Let's define the queue responsible for sending push notifications. Let's add the queue definition to queue.xml:</p>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;queue-entries&gt;</span>

  [...]

  <span class="nt">&lt;queue&gt;</span>
    <span class="nt">&lt;name&gt;</span>apns<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;rate&gt;</span>20/s<span class="nt">&lt;/rate&gt;</span>
    <span class="nt">&lt;bucket-size&gt;</span>10<span class="nt">&lt;/bucket-size&gt;</span>
    <span class="nt">&lt;max-concurrent-requests&gt;</span>5<span class="nt">&lt;/max-concurrent-requests&gt;</span>
    <span class="nt">&lt;retry-parameters&gt;</span>
        <span class="nt">&lt;task-age-limit&gt;</span>3h<span class="nt">&lt;/task-age-limit&gt;</span>
        <span class="nt">&lt;min-backoff-seconds&gt;</span>10<span class="nt">&lt;/min-backoff-seconds&gt;</span>
        <span class="nt">&lt;max-backoff-seconds&gt;</span>600<span class="nt">&lt;/max-backoff-seconds&gt;</span>
        <span class="nt">&lt;max-doublings&gt;</span>5<span class="nt">&lt;/max-doublings&gt;</span>
    <span class="nt">&lt;/retry-parameters&gt;</span>
    <span class="nt">&lt;target&gt;</span>apns<span class="nt">&lt;/target&gt;</span>
  <span class="nt">&lt;/queue&gt;</span>

  [...]

<span class="nt">&lt;/queue-entries&gt;</span>

</pre></div>

<p>Always place the queue.xml file in the <code>default</code> module to save yourself from troubles; even though the target is not the <code>default</code> module.</p>

<p>A few things to note here:</p>

<ol>
<li>We named our push queue <code>apns</code> (same name as our module but it can be anything).</li>
<li>We set <code>max-concurrent-requests</code> to <code>5</code>; it makes sense to set this to a value same as the capacity of our connection pool (see below).</li>
<li>We set <code>target</code> to <code>apns</code>; tasks will be executed in our <code>apns</code> module.</li>
</ol><h4>
<a name="task-definition" class="anchor" href="#task-definition"><span class="octicon octicon-link"></span></a>Task definition</h4>

<p>This is the most interesting part. This is how a task that we put into the queue is defined:</p>

<div class="highlight highlight-java"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SendPushNotificationToApnsTask</span> <span class="kd">implements</span> <span class="n">DeferredTask</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">ApnsConnectionFactory</span> <span class="n">sApnsConnectionFactory</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">ApnsConnectionPool</span> <span class="n">sApnsConnectionPool</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">PushNotificationService</span> <span class="n">sPushNotificationService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">APNS_CONNECTION_POOL_CAPACITY</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="n">PushNotification</span> <span class="n">mPushNotification</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">SendPushNotificationToApnsTask</span><span class="o">(</span><span class="n">PushNotification</span> <span class="n">pushNotification</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">mPushNotification</span> <span class="o">=</span> <span class="n">pushNotification</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="n">trySendingPushNotification</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CannotOpenConnectionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Could not connect to APNS"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CannotUseConnectionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
       <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Could not send: "</span> <span class="o">+</span> <span class="n">mPushNotification</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">PayloadException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">getLogger</span><span class="o">().</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not send push notification (dropping task)"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">trySendingPushNotification</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CannotOpenConnectionException</span><span class="o">,</span> <span class="n">CannotUseConnectionException</span><span class="o">,</span> <span class="n">PayloadException</span> <span class="o">{</span>
    <span class="n">ApnsConnection</span> <span class="n">apnsConnection</span> <span class="o">=</span> <span class="n">getApnsConnectionPool</span><span class="o">().</span><span class="na">obtain</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">apnsConnection</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">apnsConnection</span> <span class="o">=</span> <span class="n">openConnection</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="k">try</span> <span class="o">{</span>
      <span class="n">getLogger</span><span class="o">().</span><span class="na">debug</span><span class="o">(</span><span class="s">"Sending push notification: {}"</span><span class="o">,</span> <span class="n">mPushNotification</span><span class="o">);</span>
      <span class="n">getPushNotificationService</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="n">mPushNotification</span><span class="o">,</span> <span class="n">apnsConnection</span><span class="o">);</span>
      <span class="n">getApnsConnectionPool</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">apnsConnection</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">CannotUseConnectionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">getLogger</span><span class="o">().</span><span class="na">debug</span><span class="o">(</span><span class="s">"Could not send push notification - opening new connection"</span><span class="o">);</span>
      <span class="n">apnsConnection</span> <span class="o">=</span> <span class="n">openConnection</span><span class="o">();</span>
      <span class="n">getLogger</span><span class="o">().</span><span class="na">debug</span><span class="o">(</span><span class="s">"Retrying sending push notification"</span><span class="o">);</span>
      <span class="n">getPushNotificationService</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="n">mPushNotification</span><span class="o">,</span> <span class="n">apnsConnection</span><span class="o">);</span>
      <span class="n">getApnsConnectionPool</span><span class="o">().</span><span class="na">put</span><span class="o">(</span><span class="n">apnsConnection</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApnsConnectionPool</span> <span class="nf">getApnsConnectionPool</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sApnsConnectionPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">SendPushNotificationToApnsTask</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sApnsConnectionPool</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sApnsConnectionPool</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ApnsConnectionPool</span><span class="o">(</span><span class="n">APNS_CONNECTION_POOL_CAPACITY</span><span class="o">);</span>
        <span class="o">}</span>        
      <span class="o">}</span>
    <span class="o">}</span>  
    <span class="k">return</span> <span class="n">sApnsConnectionPool</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">PushNotificationService</span> <span class="nf">getPushNotificationService</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sPushNotificationService</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">SendPushNotificationToApnsTask</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sPushNotificationService</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">sPushNotificationService</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">DefaultPushNotificationService</span><span class="o">();</span>
        <span class="o">}</span>        
      <span class="o">}</span>
    <span class="o">}</span>  
    <span class="k">return</span> <span class="n">sPushNotificationService</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApnsConnection</span> <span class="nf">openConnection</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">CannotOpenConnectionException</span> <span class="o">{</span>
    <span class="n">getLogger</span><span class="o">().</span><span class="na">debug</span><span class="o">(</span><span class="s">"Connecting to APNS"</span><span class="o">);</span>
    <span class="k">return</span> <span class="nf">getApnsConnectionFactory</span><span class="o">().</span><span class="na">openPushConnection</span><span class="o">();</span>
  <span class="o">}</span>  

  <span class="kd">private</span> <span class="kd">static</span> <span class="n">ApnsConnectionFactory</span> <span class="nf">getApnsConnectionFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sApnsConnectionFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="kd">synchronized</span> <span class="o">(</span><span class="n">SendPushNotificationToApnsTask</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">sApnsConnectionFactory</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">DefaultApnsConnectionFactory</span><span class="o">.</span><span class="na">Builder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DefaultApnsConnectionFactory</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
          <span class="n">KeyStoreProvider</span> <span class="n">ksp</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ClassPathResourceKeyStoreProvider</span><span class="o">(</span><span class="n">PATH_TO_KEYSTORE</span><span class="o">,</span> <span class="n">KeyStoreType</span><span class="o">.</span><span class="na">PKCS12</span><span class="o">,</span> <span class="n">KEYSTORE_PWD</span><span class="o">);</span>
          <span class="n">builder</span><span class="o">.</span><span class="na">setSandboxKeyStoreProvider</span><span class="o">(</span><span class="n">ksp</span><span class="o">);</span>        
          <span class="k">try</span> <span class="o">{</span>
            <span class="n">sApnsConnectionFactory</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">build</span><span class="o">();</span>
          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ApnsException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApnsRuntimeException</span><span class="o">(</span><span class="s">"Could not create APNS connection factory"</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
          <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>  
    <span class="k">return</span> <span class="n">sApnsConnectionFactory</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">slf4j</span><span class="o">.</span><span class="na">Logger</span> <span class="nf">getLogger</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">[...]</span>
  <span class="o">}</span>
<span class="o">}</span>


</pre></div>

<p>This task is executed in the <code>apns</code> module. </p>

<p>Our connection pool has a capacity same as <code>max-concurrent-requests</code> in our queue.xml.</p>

<p>Class <code>PushNotification</code> implements <code>Serializable</code> so you can simply pass a push notification instance to the task's constructor and save it in an instance field.</p>

<p>Very important, that you set a <code>serialVersionUID</code> because if you don't it gets autogenerated for you and you might end up having a different version uid even though you didn't make any incomaptible changes to the class. If <code>serialVersionUID</code> changes then you won't be able to process old tasks still remaining in the queue with old uid (because deserialization will fail).</p>

<p>Note, that every time a runtime exception escapes the <code>run()</code> method our task is considered as failed and will be retried by App Engine later (based on <code>retry-parameters</code> in queue.xml). </p>

<p>You'll get a <code>PayloadException</code> if the payload is larger than 2048 bytes. Note that we don't throw a runtime exception in this case to avoid the hot-potato anti-pattern (payload will be still too large the next time we retry).</p>

<p>We create static members lazily because we don't want them to be created when we're just enqueuing a task.</p>

<h4>
<a name="enqueuing-tasks" class="anchor" href="#enqueuing-tasks"><span class="octicon octicon-link"></span></a>Enqueuing tasks</h4>

<div class="highlight highlight-java"><pre><span class="n">PushNotification</span> <span class="n">pn</span> <span class="o">=</span> <span class="o">...;</span> <span class="c1">// create one</span>
<span class="n">DeferredTask</span> <span class="n">task</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SendPushNotificationToApnsTask</span><span class="o">(</span><span class="n">pn</span><span class="o">);</span>
<span class="n">QueueFactory</span><span class="o">.</span><span class="na">getQueue</span><span class="o">(</span><span class="s">"apns"</span><span class="o">).</span><span class="na">add</span><span class="o">(</span><span class="n">TaskOptions</span><span class="o">.</span><span class="na">Builder</span><span class="o">.</span><span class="na">withPayload</span><span class="o">(</span><span class="n">task</span><span class="o">));</span>
</pre></div>

<p>You can enqueue the task from any module.</p>

<h4>
<a name="epilogue" class="anchor" href="#epilogue"><span class="octicon octicon-link"></span></a>Epilogue</h4>

<p>In our example we assumed that each push notification is sent to one specific user with at most a couple of devices. If you want to send a single push notification to thousands of devices you could quickly run into problems. In this case you may want to check out a <a href="http://googlecloudplatform.blogspot.hu/2013/07/google-app-engine-takes-pain-out-of-sending-ios-push-notifications.html">more sophisticated example</a> with pull queues and query cursors from Google.</p>

<p>In case you find something that is not working as expected please report it in the <a href="https://github.com/ZsoltSafrany/java-apns-gae/issues">issue tracker</a>.</p>

<p>We use this library in our own projects thus you can expect that it will remain maintained.</p>

<h1>
<a name="download" class="anchor" href="#download"><span class="octicon octicon-link"></span></a>Download</h1>

<p><a href="http://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&amp;g=com.zsoltsafrany&amp;a=java-apns-gae&amp;v=LATEST">↓ Latest JAR</a></p>

<p>The source code of the library is <a href="https://github.com/ZsoltSafrany/java-apns-gae">available on GitHub</a>.</p>

<h2>
<a name="maven" class="anchor" href="#maven"><span class="octicon octicon-link"></span></a>Maven</h2>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>com.zsoltsafrany<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>java-apns-gae<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.2.0<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<h2>
<a name="gradle" class="anchor" href="#gradle"><span class="octicon octicon-link"></span></a>Gradle</h2>

<div class="highlight highlight-Groovy"><pre><span class="n">compile</span> <span class="s1">'com.zsoltsafrany:java-apns-gae:1.2.0'</span>
</pre></div>

<h1>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h1>

<div class="highlight highlight-HTML"><pre>The MIT License (MIT)

Copyright (c) 2014 Zsolt Safrany

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
</pre></div>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/ZsoltSafrany">ZsoltSafrany</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-53950173-2");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>